"use strict";function CropImageCtrl(e,t,r,n,i,o,a,l){var c,p,d,s,u,h,f=this,g=0;f.$onInit=function(){f.cropper={},f.cropperProxy="ctrl.cropper.callMethod",f.showEvent="show",f.hideEvent="hide",d=function(){e.$broadcast(f.showEvent)},s=function(){e.$broadcast(f.hideEvent)},f.options={viewMode:3,dragMode:"move",cropBoxMovable:!1,cropBoxResizable:!1,doubleClickToggle:!1,minContainerWidth:420,build:f.updatePreview,dragend:f.updatePreview,zoomin:f.updatePreview,zoomout:f.updatePreview,crop:function(e){p=e}};o.pixelsPerBead;f.heightOptions=o.heightOptions,f.widthOptions=o.widthOptions,f.selectedHeight=f.heightOptions[0].beads,f.selectedWidth=f.widthOptions[0].beads,f.previewHeight=650,f.getCroppedData=b,n(d)},f.$onChanges=function(e){e.blob&&e.blob.currentValue&&i.encode(c=e.blob.currentValue).then(function(e){f.cropper.callMethod("replace",e),n(function(){f.cropper.callMethod("setDragMode","move"),u=f.cropper.callMethod("getContainerData"),f.cropper.callMethod("setCanvasData",{top:0,height:u.height}),f.showEditButtons=!0,f.updatePreview()})})};var m=function(){if(f.cropper.callMethod&&u){var e=f.selectedWidth*o.beadWidth/(f.selectedHeight*o.beadHeight);f.previewWidth=parseInt(f.previewHeight*e),f.cropper.callMethod("setAspectRatio",e);var t=a.getResizeData(u,f.cropper.callMethod("getCanvasData"),f.cropper.callMethod("getImageData"),e);t.image&&f.cropper.callMethod("setCanvasData",t.image),f.cropper.callMethod("setCropBoxData",t.cropBox)}};f.rotate=function(e){f.cropper.callMethod&&(f.cropper.callMethod("rotate",g-f.rotation),g=f.rotation)},f.zoom=function(e){f.cropper.callMethod&&f.cropper.callMethod("zoom",e)},f.updatePreview=function(){return m(),v(f.previewHeight,f.previewWidth).then(function(e){h=e,f.previewUrl=e.toDataURL()})};var v=function(e,r){return c&&p?t.resolve(f.cropper.callMethod("getCroppedCanvas")).then(function(e){return l.getPalette(e,3)}).then(function(e){return a.bestColorOption(e,f.dominantColor)}).then(function(t){return f.cropper.callMethod("getCroppedCanvas",{height:e,width:r,fillColor:a.rgbToHex(t)})}):t.reject()},b=function(){return t.resolve(h)}}function cropImage(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{blob:"<",selectedHeight:"=beadHeight",selectedWidth:"=beadWidth",colorCount:"=",getCroppedData:"="},controller:["$scope","$q","$http","$timeout","Cropper","PEYOTE_VALUES","CropImageService","$colorThief",CropImageCtrl],controllerAs:"ctrl",templateUrl:"js/components/cropImage/cropImage.html"}}function CropImageService(e){var t=function(e,t){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2))},r=function(e){return function(r){return t(r,e)}},n=function(e){var t=e.toString(16);return 1==t.length?"0"+t:t};return{getResizeData:function(e,t,r,n){var i={width:e.height*n,height:e.height,top:0};i.left=(e.width-i.width)/2;var o;return t.width<i.width&&(o={width:i.width,height:i.width/r.aspectRatio}),i.left<t.left?o=angular.extend({},o,{left:i.left}):i.left+i.width>t.left+t.width&&(o=angular.extend({},o,{left:t.left+(i.left+i.width-(t.left+t.width))})),{image:o,cropBox:i}},bestColorOption:function(e,t){if(null===e||e.length<1||!t)return"#afa0af";e=angular.copy(e);var n=r(t);return e.sort(function(e,t){return n(e)-n(t)}),e[0]},rgbToHex:function(e){return"#"+n(e[0])+n(e[1])+n(e[2])}}}function fileUpload(){return{restrict:"E",require:"^^finalizeModal",scope:{label:"<"},link:function(e,t,r,n){e.onUpload=n.onFile},templateUrl:"js/components/fileUpload/fileUpload.html"}}function NavbarCtrl(){this.$onInit=function(){}}function navbar(){return{restrict:"E",scope:{},bindToController:{},controller:[NavbarCtrl],controllerAs:"ctrl",templateUrl:"js/components/navbar/navbar.html"}}function OrderReviewCtrl(e){var t=this;t.$onInit=function(){t.templatePrice=20,t.pricePerSquareInch=1.5,t.pricePerColor=1,t.priceForClasps=3,t.priceToShip=5,t.salesTax=.06,t.mustShip=r};var r=function(){return t.includeBeads||t.includeClasps};t.$onChanges=function(r){(r.beadHeight||r.beadWidth)&&(t.templateSize=e.calculateTemplateSize(t.beadHeight,t.beadWidth)),t.updateFinalPrice()},t.updateFinalPrice=function(){t.subtotal=e.calculateSubtotal({templateSize:t.templateSize,colorCount:t.colorCount,includeBeads:t.includeBeads,includeClasps:t.includeClasps});var n=e.shippingAndTaxCost(t.subtotal,r());t.finalPrice=t.subtotal+n}}function orderReview(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{beadHeight:"<",beadWidth:"<",colorCount:"<",finalPrice:"=",includeBeads:"=",includeClasps:"=",mustShip:"="},controller:["OrderReviewService",OrderReviewCtrl],controllerAs:"ctrl",templateUrl:"js/components/orderReview/orderReview.html"}}function OrderReviewService(e,t){return{calculateTemplateSize:function(t,r){var n=e.heightOptions.find(function(e){return e.beads===t})||{},i=e.widthOptions.find(function(e){return e.beads===r})||{},o=n.inches+" in. x "+i.inches+" in.",a=parseInt(n.beads)+" x "+i.beads+" beads";return{inches:{display:o,value:n.inches*i.inches},beads:{display:a,value:parseInt(n.beads)*i.beads}}},calculateSubtotal:function(e){var r=t.templatePrice;return e.includeBeads&&e.templateSize&&(r+=t.pricePerSquareInch*e.templateSize.inches.value,r+=t.pricePerColor*(e.colorCount-12)),e.includeClasps&&(r+=t.priceForClasps),r},shippingAndTaxCost:function(e,r){return e*t.salesTax+r?t.priceToShip:0}}}function MakePaymentCtrl(e,t,r,n,i,o){var a,l,c,p,d,s=this,u={};s.$onInit=function(){s.zipCodeLength=5,p={visa:"pf-visa",mastercard:"pf-mastercard",amex:"pf-american-express",discover:"pf-discover",diners:"pf-diners",jcb:"pf-jcb",unknown:"pf-credit-card"},a=angular.element(t.document)[0];(l=t.Stripe(i.publishableKey)).charges;var e=l.elements();c=e.create("cardNumber",{classes:{base:"form-control"}});var r=e.create("cardExpiry",{classes:{base:"form-control"}}),n=e.create("cardCvc",{classes:{base:"form-control"}});c.mount("#card-number"),r.mount("#card-expiry"),n.mount("#card-cvc"),c.on("change",function(e){e.brand&&f(e.brand),u.cardNumber=e.complete,s.canContinue()}),r.on("change",function(e){u.cardExpiry=e.complete,s.canContinue()}),n.on("change",function(e){u.cardCvc=e.complete,s.canContinue()}),d=h(),s.stripeCharge=m};var h=function(){return!!(u.cardNumber&&u.cardExpiry&&u.cardCvc)&&(!!s.cardholderName&&!(!s.zipCode||s.zipCode.length<5))};s.canContinue=function(){d&&!h()?(e.$emit("can-continue-with-payment",!1),d=!1):!d&&h()&&(e.$emit("can-continue-with-payment",!0),d=!0,g())};var f=function(e){var t=a.getElementById("brand-icon"),r="pf-credit-card";e in p&&(r=p[e]);for(var n=t.classList.length-1;n>=0;n--)t.classList.remove(t.classList[n]);t.classList.add("pf"),t.classList.add(r)},g=function(){var e={name:s.cardholderName,address_zip:s.zipCode},t=r.defer();return l.createToken(c,e).then(function(e){e.token?t.resolve({token:e.token.id,name:s.cardholderName}):t.reject(e.error||e)}).catch(function(e){t.reject(e)}),t.promise},m=function(e,t){return g().then(function(r){return o.finalize(e,t,r)}).catch(function(e){return r.reject()})}}function makePayment(){return{restrict:"E",scope:{},bindToController:{mustShip:"&",totalPrice:"<",stripeCharge:"="},controller:["$scope","$window","$q","$http","STRIPE","FinalizeService",MakePaymentCtrl],controllerAs:"ctrl",templateUrl:"js/components/payment/makePayment.html"}}function PictureCarouselCtrl(){var e=this;e.$onInit=function(){e.images=[],e.interval=1e3*(e.picIntervalSeconds||5);for(var t=0;t<e.picCount;t++)e.images.push({url:e.picPath+"/"+e.picPrefix+(t+1)+"."+(e.picFileType||"png"),id:t})}}function pictureCarousel(){return{restrict:"E",scope:{},bindToController:{picPath:"@",picPrefix:"@",picCount:"@",picFileType:"@?",picIntervalSeconds:"@?"},controller:[PictureCarouselCtrl],controllerAs:"ctrl",templateUrl:"js/components/pictureCarousel/pictureCarousel.html"}}function pixelizer(e,t){return{restrict:"E",require:"^^finalizeModal",scope:{pixelizeId:"@",height:"@pixelizerHeight",width:"<pixelizerWidth"},link:function(r,n,i,o){r.progressbar=e.createInstance(),r.progressbar.setParent(angular.element(n).children()[0]),paper.setup(angular.element(n).children()[0].children[0]),r.$on("pixelize-"+r.pixelizeId,function(e,n,i,o){r.showPixelizedCanvas=!1,r.progressbar.start();var a=new paper.Raster(n,new paper.Point(0,0));a.on("load",function(){project.activeLayer.removeChildren(),a.fitBounds(paper.view.bounds,!0);var e=parseInt(i.columns),n=parseInt(i.rows),l=r.width/e,c=r.height/n;a.size=new paper.Size(e,n);for(var p=0;p<n;p++){for(var d=0;d<e;d++){var s=a.getPixel(new paper.Point(d,p)),u=new paper.Path.Rectangle(new paper.Point(d*l,p*c),new paper.Size(l,c)),h=t.bestColorOption(o,[256*s.red,256*s.green,256*s.blue]);u.fillColor=new paper.Color(h[0]/256,h[1]/256,h[2]/256)}r.progressbar.set(p/n*100)}r.progressbar.complete(),r.showPixelizedCanvas=!0}),paper.project.activeLayer.position=paper.view.center})},template:'<div id="{{pixelizeId}}-progress" ng-show="showPixelizedCanvas"><canvas id="{{pixelizeId}}" height="650" width="width"class="pixelizer"></canvas></div>'}}function Config(e,t,r,n){e.hashPrefix("!"),e.html5Mode({enabled:!1,requireBase:!1}),t.when("/home",{templateUrl:"js/views/home.html"}).when("/about",{templateUrl:"js/views/about.html"}).when("/faq",{templateUrl:"js/views/faq.html"}).when("/contact",{templateUrl:"js/views/contact.html"}),t.otherwise({redirectTo:"/home"}),r.errorOnUnhandledRejections(!1)}function rangeFilter(){return function(e,t,r,n){n=n||1,r=parseInt(r);for(var i=t;i<r;i+=n)e.push(i);return e}}function FinalizeCtrl(e,t){var r=this;r.$onInit=function(){e(function(){paper.install(window)})},r.checkout=function(){t.open({component:"finalizeModal",size:"lg",windowClass:"finalize-modal",backdrop:"static"}).closed.then(function(){console.log("Done")})}}function finalize(){return{restrict:"E",scope:{},bindToController:{buttonText:"@"},controller:["$timeout","$uibModal",FinalizeCtrl],controllerAs:"ctrl",templateUrl:"js/finalize/finalize.html"}}function FinalizeService(e){var t=function(t,r){return e({method:"POST",url:"/upload",data:{blob:t.toDataURL(),key:r+"-"+(new Date).toISOString().replace(/(-|:|\.)/g,"")}})},r=function(t,r){return e({method:"POST",url:"/charge",data:{specs:r,token:t}})};return{finalize:function(e,n,i){return t(e,i.name).then(function(){return r(i.token,n)})}}}function FinalizeModalCtrl(e,t,r,n,i){var o,a=this;a.$onInit=function(){a.modalPages={uploadImage:{id:"uploadImage",title:"Upload Image",next:"cropImage"},cropImage:{id:"cropImage",back:"uploadImage",title:"Crop Image",next:"reviewOrder"},reviewOrder:{id:"reviewOrder",back:"cropImage",title:"Review Order",next:"addPayment"},addPayment:{id:"addPayment",back:"reviewOrder",title:"Add Payment"}},a.currentPage=a.modalPages.uploadImage,a.colorCount=12,a.orderReviewPixelizerId="review-order-preview",e.$on("can-continue-with-payment",function(e,r){t(function(){a.canContinueWithPayment=r})})},a.goToNextPage=function(){a.currentPage=a.modalPages[a.currentPage.next]},a.goToPreviousPage=function(){a.currentPage=a.modalPages[a.currentPage.back]},a.onFile=function(e){a.blob=e,t(function(){a.blob=e,a.goToNextPage()})},a.imageUploaded=function(){if("uploadImage"===a.currentPage.id)return angular.isDefined(a.blob)},a.cropAndContinue=function(){var t=a.selectedWidth*i.beadWidth/(a.selectedHeight*i.beadHeight);a.previewWidth=parseInt(650*t),a.getCroppedData().then(function(t){o=angular.copy(t);var r=t.toDataURL(),i={rows:a.selectedHeight,columns:a.selectedWidth},l=n.getPalette(t,a.colorCount);return e.$broadcast("pixelize-"+a.orderReviewPixelizerId,r,i,l),r}).then(function(e){a.goToNextPage()})},a.payAndContinue=function(){var e={beadHeight:a.selectedHeight,beadWidth:a.selectedWidth,colorCount:a.colorCount,includeBeads:a.includeBeads,includeClasps:a.includeClasps};return a.checkout(o,e).then(function(e){return console.log(e),e})},a.close=function(){a.modalInstance.close()}}function finalizeModal(){return{restrict:"E",scope:{},bindToController:{modalInstance:"="},controller:["$scope","$timeout","$http","$colorThief","PEYOTE_VALUES",FinalizeModalCtrl],controllerAs:"ctrl",link:function(e,t,r,n){paper.install(e),e.$on("goToPage",function(e,t){n.currentPage=n.modalPages[t]})},templateUrl:"js/finalize/modal/finalizeModal.html"}}angular.module("app",["ngRoute","ngAnimate","ui.bootstrap","ui.bootstrap-slider","ngProgress","ngCropper","ngColorThief","angular-stripe"]),angular.module("app").directive("peyoteCrop",[cropImage]),angular.module("app").factory("CropImageService",["$q",CropImageService]),angular.module("app").directive("fileUpload",[fileUpload]),angular.module("app").directive("navbar",[navbar]),angular.module("app").directive("orderReview",[orderReview]),angular.module("app").factory("OrderReviewService",["PEYOTE_VALUES","PEYOTE_PRICES",OrderReviewService]),angular.module("app").directive("makePayment",[makePayment]),angular.module("app").directive("pictureCarousel",[pictureCarousel]),angular.module("app").directive("pixelizer",["ngProgressFactory","CropImageService",pixelizer]),angular.module("app").config(["$locationProvider","$routeProvider","$qProvider","STRIPE",Config]),angular.module("app").constant("PEYOTE_VALUES",{braceletPixelWidth:600,pixelsPerInch:300,pixelsPerBead:28,heightOptions:[{beads:93.5,inches:6.5,description:"6.5 in."},{beads:100.5,inches:7,description:"7 in."},{beads:107.5,inches:7.5,description:"7.5 in."},{beads:114.5,inches:8,description:"8 in."},{beads:121.5,inches:8.5,description:"8.5 in."},{beads:129.5,inches:9,description:"9 in."},{beads:136.5,inches:9.5,description:"9.5 in."}],widthOptions:[{beads:24,inches:1.2,description:"Skinny (1.2 in.)"},{beads:27,inches:1.35,description:"Normal (1.35 in.)"},{beads:30,inches:1.5,description:"Wide (1.5 in.)"}],beadHeight:14,beadWidth:10}).constant("STRIPE",{publishableKey:"pk_test_8lpNNwFVokUif3qxk2N7fPd6"}).constant("PEYOTE_PRICES",{templatePrice:20,pricePerSquareInch:1.5,pricePerColor:1,priceForClasps:3,priceToShip:5,salesTax:.06}),angular.module("app").filter("range",[rangeFilter]),angular.module("app").directive("finalize",[finalize]),angular.module("app").factory("FinalizeService",["$http",FinalizeService]),angular.module("app").directive("finalizeModal",[finalizeModal]);