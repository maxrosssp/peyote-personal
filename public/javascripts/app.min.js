"use strict";function CropImageCtrl(e,t,r,n,i,a,o,c){var l,d,p,s,u,g=this,h=0;g.$onInit=function(){g.cropper={},g.cropperProxy="ctrl.cropper.callMethod",g.showEvent="show",g.hideEvent="hide",d=function(){e.$broadcast(g.showEvent)},p=function(){e.$broadcast(g.hideEvent)},g.options={viewMode:3,dragMode:"move",cropBoxMovable:!1,cropBoxResizable:!1,doubleClickToggle:!1,minContainerWidth:420,build:g.updatePreview,dragend:g.updatePreview,zoomin:g.updatePreview,zoomout:g.updatePreview,crop:function(e){l=e}};a.pixelsPerBead;g.heightOptions=a.heightOptions,g.widthOptions=a.widthOptions,g.selectedHeight=g.heightOptions[0].beads,g.selectedWidth=g.widthOptions[0].beads,g.previewHeight=650,g.getCroppedData=b,n(d)},g.$onChanges=function(e){e.uploadedFile&&e.uploadedFile.currentValue?i.encode(e.uploadedFile.currentValue).then(function(e){g.cropper.callMethod("replace",e),n(m)}):e.downloadedUrl&&e.downloadedUrl.currentValue&&(g.cropper.callMethod("replace",e.downloadedUrl.currentValue),n(m))};var m=function(){g.cropper.callMethod("setDragMode","move"),s=g.cropper.callMethod("getContainerData"),g.cropper.callMethod("setCanvasData",{top:0,height:s.height}),g.showEditButtons=!0,g.updatePreview()},f=function(){if(g.cropper.callMethod&&s){var e=g.selectedWidth*a.beadWidth/(g.selectedHeight*a.beadHeight);g.previewWidth=parseInt(g.previewHeight*e),g.cropper.callMethod("setAspectRatio",e);var t=o.getResizeData(s,g.cropper.callMethod("getCanvasData"),g.cropper.callMethod("getImageData"),e);t.image&&g.cropper.callMethod("setCanvasData",t.image),g.cropper.callMethod("setCropBoxData",t.cropBox)}};g.rotate=function(e){g.cropper.callMethod&&(g.cropper.callMethod("rotate",h-g.rotation),h=g.rotation)},g.zoom=function(e){g.cropper.callMethod&&g.cropper.callMethod("zoom",e)},g.updatePreview=function(){return f(),v(g.previewHeight,g.previewWidth).then(function(e){u=e,g.previewUrl=e.toDataURL()})};var v=function(e,r){return l?t.resolve(g.cropper.callMethod("getCroppedCanvas")).then(function(e){return c.getPalette(e,3)}).then(function(e){return o.bestColorOption(e,g.dominantColor)}).then(function(t){return g.cropper.callMethod("getCroppedCanvas",{height:e,width:r,fillColor:o.rgbToHex(t)})}):t.reject()},b=function(){return t.resolve(u)}}function cropImage(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{uploadedFile:"<",downloadedUrl:"<",selectedHeight:"=beadHeight",selectedWidth:"=beadWidth",colorCount:"=",getCroppedData:"="},controller:["$scope","$q","$http","$timeout","Cropper","PEYOTE_VALUES","CropImageService","$colorThief",CropImageCtrl],controllerAs:"ctrl",templateUrl:"js/components/cropImage/cropImage.html"}}function CropImageService(e){var t=function(e,t){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2))},r=function(e){return function(r){return t(r,e)}},n=function(e){var t=e.toString(16);return 1==t.length?"0"+t:t};return{getResizeData:function(e,t,r,n){var i={width:e.height*n,height:e.height,top:0};i.left=(e.width-i.width)/2;var a;return t.width<i.width&&(a={width:i.width,height:i.width/r.aspectRatio}),i.left<t.left?a=angular.extend({},a,{left:i.left}):i.left+i.width>t.left+t.width&&(a=angular.extend({},a,{left:t.left+(i.left+i.width-(t.left+t.width))})),{image:a,cropBox:i}},bestColorOption:function(e,t){if(null===e||e.length<1||!t)return"#afa0af";e=angular.copy(e);var n=r(t);return e.sort(function(e,t){return n(e)-n(t)}),e[0]},rgbToHex:function(e){return"#"+n(e[0])+n(e[1])+n(e[2])}}}function FileUploadCtrl(e,t){var r=this;r.checkLink=function(t){return n(t).then(function(t){e.onDownload(t)}).catch(function(e){r.linkError=!0,r.linkErrorMessage=e.data})},r.updateLink=function(){r.linkError=!1};var n=function(e){return t({method:"POST",url:"/image/download",data:{imageUrl:e}}).then(function(e){return e.data})}}function fileUpload(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{fileLabel:"<",linkLabel:"<"},controller:["$scope","$http",FileUploadCtrl],controllerAs:"ctrl",link:function(e,t,r,n){e.onUpload=n.onFile,e.onDownload=n.onLink},templateUrl:"js/components/fileUpload/fileUpload.html"}}function NavbarCtrl(){this.$onInit=function(){}}function navbar(){return{restrict:"E",scope:{},bindToController:{},controller:[NavbarCtrl],controllerAs:"ctrl",templateUrl:"js/components/navbar/navbar.html"}}function OrderReviewCtrl(e,t){var r=this;r.$onInit=function(){r.disableShipping=e.disableShipping,r.prices=e,r.mustShip=n};var n=function(){return!r.disableShipping&&(r.includeBeads||r.includeClasps)};r.$onChanges=function(e){(e.beadHeight||e.beadWidth)&&(r.templateSize=t.calculateTemplateSize(r.beadHeight,r.beadWidth)),r.updateFinalPrice()},r.updateFinalPrice=function(){r.subtotal=t.calculateSubtotal({templateSize:r.templateSize,colorCount:r.colorCount,includeBeads:!r.disableShipping&&r.includeBeads,includeClasps:!r.disableShipping&&r.includeClasps});var e=t.shippingAndTaxCost(r.subtotal,n());r.finalPrice=r.subtotal+e}}function orderReview(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{beadHeight:"<",beadWidth:"<",colorCount:"<",finalPrice:"=",includeBeads:"=",includeClasps:"=",mustShip:"="},controller:["PEYOTE_PRICES","OrderReviewService",OrderReviewCtrl],controllerAs:"ctrl",templateUrl:"js/components/orderReview/orderReview.html"}}function OrderReviewService(e,t){return{calculateTemplateSize:function(t,r){var n=e.heightOptions.find(function(e){return e.beads===t})||{},i=e.widthOptions.find(function(e){return e.beads===r})||{},a=n.inches+" in. x "+i.inches+" in.",o=parseInt(n.beads)+" x "+i.beads+" beads";return{inches:{display:a,value:n.inches*i.inches},beads:{display:o,value:parseInt(n.beads)*i.beads}}},calculateSubtotal:function(e){var r=t.templatePrice;return e.includeBeads&&e.templateSize&&(r+=t.pricePerSquareInch*e.templateSize.inches.value,r+=t.pricePerColor*(e.colorCount-12)),e.includeClasps&&(r+=t.priceForClasps),r},shippingAndTaxCost:function(e,r){return e*t.salesTax+(r?t.priceToShip:0)}}}function MakePaymentCtrl(e,t,r,n,i,a){var o=this;o.zipLength=5,o.$onInit=function(){o.card={},o.paymentForm={},o.finalizeCheckout=p,e.progressbar=a.createInstance(),e.progressbar.setHeight("7px"),e.progressbar.setParent(angular.element(document.getElementById("make-payment-page"))[0]),e.$watch(o.card.cvc,function(e,t){e&&e.length>n[o.paymentForm.cardNumber.$ccEagerType].cvcLength&&(o.card.cvc=t)}),e.$watch(function(){return o.paymentForm.$valid&&o.cardholderInfo.$valid},function(t){e.$emit("toggle-checkout-button",t)})},o.getPfClass=function(e){return e?n[e].iconClass:"pf-credit-card"},o.inputClass=function(e){return o.paymentForm[e]&&c(e)?o.paymentForm[e].$invalid?"has-error":"has-success":""},o.updateFunctions={cardNumber:function(){var e=n[o.paymentForm.cardNumber.$ccEagerType];e&&o.card.number.length>e.length&&(o.card.number=o.card.number.slice(0,e.length))},cardCvc:function(){var e=n[o.paymentForm.cardNumber.$ccEagerType];e&&o.card.cvc.length>e.cvcLength&&(o.card.cvc=o.card.cvc.slice(0,e.cvcLength))},cardExpMonth:function(e){if(o.card.exp_month>12&&(o.card.exp_month=parseInt(o.paymentForm.cardExpMonth.$viewValue[0])),o.card.exp_month>1||o.paymentForm.cardExpMonth.$viewValue&&o.paymentForm.cardExpMonth.$viewValue.length>1){var t=o.paymentForm.$$element[0].elements.cardExpYear;t&&t.focus()}},cardExpYear:function(e){if(!o.paymentForm.cardExpYear.$viewValue[0]&&("Backspace"===e.key||8===e.keyCode)){var t=o.paymentForm.$$element[0].elements.cardExpMonth;t&&t.focus()}}};var c=function(e){var t=o.paymentForm[e];if(t.$pristine)return!1;switch(e){case"cardNumber":return!!t.$ccEagerType&&n[t.$ccEagerType].length===t.$$rawModelValue.length;case"cardCvc":return t.$$rawModelValue.length>=3;case"cardAddressZip":return t.$$rawModelValue.length>=5;default:return!0}},l=function(){return r.card.createToken(o.card)},d=function(){return o.email===o.emailConfirm?t.resolve():t.reject({type:"emailMatch",message:"E-mails do not match"})},p=function(t,r){return e.progressbar.start(),d().then(function(){return l()}).then(function(n){return e.progressbar.set(50),r.email=o.email,i.finalize(t,r,n)}).catch(function(e){e.type?o.error=e:o.errorAlert=e.data}).finally(function(){e.progressbar.complete()})}}function makePayment(){return{restrict:"E",scope:{},bindToController:{mustShip:"&",totalPrice:"<",finalizeCheckout:"="},controller:["$scope","$q","stripe","CARD_TYPES","FinalizeService","ngProgressFactory",MakePaymentCtrl],controllerAs:"ctrl",templateUrl:"js/components/payment/makePayment.html"}}function PictureCarouselCtrl(){var e=this;e.$onInit=function(){e.images=[],e.interval=1e3*(e.picIntervalSeconds||5);for(var t=0;t<e.picCount;t++)e.images.push({url:e.picPath+"/"+e.picPrefix+(t+1)+"."+(e.picFileType||"png"),id:t})}}function pictureCarousel(){return{restrict:"E",scope:{},bindToController:{picPath:"@",picPrefix:"@",picCount:"@",picFileType:"@?",picIntervalSeconds:"@?"},controller:[PictureCarouselCtrl],controllerAs:"ctrl",templateUrl:"js/components/pictureCarousel/pictureCarousel.html"}}function pixelizer(e,t){return{restrict:"E",require:"^^finalizeModal",scope:{pixelizeId:"@",height:"@pixelizerHeight",width:"<pixelizerWidth"},link:function(r,n,i,a){r.progressbar=e.createInstance(),r.progressbar.setHeight("7px"),r.progressbar.setParent(angular.element(n).children()[0]),paper.setup(angular.element(n).children()[0].children[0]),r.$on("pixelize-"+r.pixelizeId,function(e,n,i,a){r.showPixelizedCanvas=!1,r.progressbar.start();var o=new paper.Raster(n,new paper.Point(0,0));o.on("load",function(){project.activeLayer.removeChildren(),o.fitBounds(paper.view.bounds,!0);var e=parseInt(i.columns),n=parseInt(i.rows),c=r.width/e,l=r.height/n;o.size=new paper.Size(e,n);for(var d=0;d<n;d++){for(var p=0;p<e;p++){var s=o.getPixel(new paper.Point(p,d)),u=new paper.Path.Rectangle(new paper.Point(p*c,d*l),new paper.Size(c,l)),g=t.bestColorOption(a,[256*s.red,256*s.green,256*s.blue]);u.fillColor=new paper.Color(g[0]/256,g[1]/256,g[2]/256)}r.progressbar.set(d/n*100)}r.progressbar.complete(),r.showPixelizedCanvas=!0}),paper.project.activeLayer.position=paper.view.center})},template:'<div id="{{pixelizeId}}-progress" ng-show="showPixelizedCanvas"><canvas id="{{pixelizeId}}" height="650" width="width"class="pixelizer"></canvas></div>'}}function Config(e,t,r,n,i){e.html5Mode({enabled:!0,requireBase:!1}).hashPrefix("!"),t.when("/",{templateUrl:"js/views/home.html"}).when("/about",{templateUrl:"js/views/about.html"}).when("/faq",{templateUrl:"js/views/faq.html"}).when("/contact",{templateUrl:"js/views/contact.html"}),t.otherwise({redirectTo:"/"}),r.errorOnUnhandledRejections(!1),n.setPublishableKey("pk_live_ZJzerFM21zkDAlC01ylnd7dA"),i.defaults.useXDomain=!0}function rangeFilter(){return function(e,t,r,n){n=n||1,r=parseInt(r);for(var i=t;i<r;i+=n)e.push(i);return e}}function FinalizeCtrl(e,t){var r=this;r.$onInit=function(){e(function(){paper.install(window)})},r.checkout=function(){t.open({component:"finalizeModal",size:"lg",windowClass:"finalize-modal",backdrop:"static"}).closed.then(function(){console.log("Done")})}}function finalize(){return{restrict:"E",scope:{},bindToController:{buttonText:"@"},controller:["$timeout","$uibModal",FinalizeCtrl],controllerAs:"ctrl",templateUrl:"js/finalize/finalize.html"}}function FinalizeService(e){var t=function(t,r,n){return e({method:"POST",url:"/checkout",data:{url:t,specs:r,token:n}})};return{finalize:function(e,r,n){return t(e,r,n).then(function(e){return console.log("Done with checkout"),console.log(e),e}).catch(function(e){throw console.log("There was an error"),console.log(e),e})}}}function FinalizeModalCtrl(e,t,r,n,i,a){var o,c=this;c.$onInit=function(){c.modalPages={uploadImage:{id:"uploadImage",title:"Upload Image",next:"cropImage"},cropImage:{id:"cropImage",back:"uploadImage",title:"Crop Image",next:"reviewOrder"},reviewOrder:{id:"reviewOrder",back:"cropImage",title:"Review Order",next:"addPayment"},addPayment:{id:"addPayment",back:"reviewOrder",title:"Add Payment"}},c.currentPage=c.modalPages.uploadImage,c.colorCount=12,c.orderReviewPixelizerId="review-order-preview",t.$on("toggle-checkout-button",function(e,t){c.canAttemptCheckout=t})},c.goToNextPage=function(){c.currentPage=c.modalPages[c.currentPage.next]},c.goToPreviousPage=function(){c.currentPage=c.modalPages[c.currentPage.back]},c.onFile=function(e){r(function(){c.uploadedFile=e,c.goToNextPage()})},c.onLink=function(e){r(function(){c.downloadedUrl=e,c.goToNextPage()})},c.imageUploaded=function(){return angular.isDefined(c.uploadedFile)||angular.isDefined(c.downloadedUrl)},c.cropAndContinue=function(){var e=c.selectedWidth*a.beadWidth/(c.selectedHeight*a.beadHeight);c.previewWidth=parseInt(650*e),c.getCroppedData().then(function(e){var r=e.toDataURL();o=angular.copy(r);var n={rows:c.selectedHeight,columns:c.selectedWidth},a=i.getPalette(e,c.colorCount);return t.$broadcast("pixelize-"+c.orderReviewPixelizerId,r,n,a),r}).then(function(e){c.goToNextPage()})},c.payAndContinue=function(){var t={beadHeight:c.selectedHeight,beadWidth:c.selectedWidth,colorCount:c.colorCount,includeBeads:c.includeBeads,includeClasps:c.includeClasps};return c.finalizeCheckout(o,t).then(function(t){if(console.log(t.data),!t.data.path)return t.data;e.location.href=t.data.path})},c.close=function(){c.modalInstance.close()}}function finalizeModal(){return{restrict:"E",scope:{},bindToController:{modalInstance:"="},controller:["$window","$scope","$timeout","$http","$colorThief","PEYOTE_VALUES",FinalizeModalCtrl],controllerAs:"ctrl",link:function(e,t,r,n){paper.install(e),e.$on("goToPage",function(e,t){n.currentPage=n.modalPages[t]})},templateUrl:"js/finalize/modal/finalizeModal.html"}}angular.module("app",["ngRoute","ngAnimate","ui.bootstrap","ui.bootstrap-slider","ngProgress","ngCropper","ngColorThief","angular-stripe","credit-cards"]),angular.module("app").directive("peyoteCrop",[cropImage]),angular.module("app").factory("CropImageService",["$q",CropImageService]),angular.module("app").directive("fileUpload",[fileUpload]),angular.module("app").directive("navbar",[navbar]),angular.module("app").directive("orderReview",[orderReview]),angular.module("app").factory("OrderReviewService",["PEYOTE_VALUES","PEYOTE_PRICES",OrderReviewService]),angular.module("app").directive("makePayment",[makePayment]),angular.module("app").directive("pictureCarousel",[pictureCarousel]),angular.module("app").directive("pixelizer",["ngProgressFactory","CropImageService",pixelizer]),angular.module("app").config(["$locationProvider","$routeProvider","$qProvider","stripeProvider","$httpProvider",Config]),angular.module("app").constant("PEYOTE_VALUES",{braceletPixelWidth:600,pixelsPerInch:300,pixelsPerBead:28,heightOptions:[{beads:93.5,inches:6.5,description:"6.5 in."},{beads:100.5,inches:7,description:"7 in."},{beads:107.5,inches:7.5,description:"7.5 in."},{beads:114.5,inches:8,description:"8 in."},{beads:121.5,inches:8.5,description:"8.5 in."},{beads:129.5,inches:9,description:"9 in."},{beads:136.5,inches:9.5,description:"9.5 in."}],widthOptions:[{beads:24,inches:1.2,description:"Skinny (1.2 in.)"},{beads:27,inches:1.35,description:"Normal (1.35 in.)"},{beads:30,inches:1.5,description:"Wide (1.5 in.)"}],beadHeight:14,beadWidth:10}).constant("STRIPE",{publishableKey:"pk_test_8lpNNwFVokUif3qxk2N7fPd6"}).constant("PEYOTE_PRICES",{disableShipping:!0,templatePrice:20,pricePerSquareInch:1.5,pricePerColor:1,priceForClasps:3,priceToShip:5,salesTax:.06}).constant("MIME",{imageTypes:{apng:"image/apng",bmp:"image/x-ms-bmp",cgm:"image/cgm",g3:"image/g3fax",gif:"image/gif",ief:"image/ief",jpeg:"image/jpeg",jpg:"image/jpeg",jpe:"image/jpeg",ktx:"image/ktx",png:"image/png",btif:"image/prs.btif",sgi:"image/sgi",svg:"image/svg+xml",svgz:"image/svg+xml",tiff:"image/tiff",tif:"image/tiff",psd:"image/vnd.adobe.photoshop",uvi:"image/vnd.dece.graphic",uvvi:"image/vnd.dece.graphic",uvg:"image/vnd.dece.graphic",uvvg:"image/vnd.dece.graphic",djvu:"image/vnd.djvu",djv:"image/vnd.djvu",sub:"text/vnd.dvb.subtitle",dwg:"image/vnd.dwg",dxf:"image/vnd.dxf",fbs:"image/vnd.fastbidsheet",fpx:"image/vnd.fpx",fst:"image/vnd.fst",mmr:"image/vnd.fujixerox.edmics-mmr",rlc:"image/vnd.fujixerox.edmics-rlc",mdi:"image/vnd.ms-modi",wdp:"image/vnd.ms-photo",npx:"image/vnd.net-fpx",wbmp:"image/vnd.wap.wbmp",xif:"image/vnd.xiff",webp:"image/webp","3ds":"image/x-3ds",ras:"image/x-cmu-raster",cmx:"image/x-cmx",fh:"image/x-freehand",fhc:"image/x-freehand",fh4:"image/x-freehand",fh5:"image/x-freehand",fh7:"image/x-freehand",ico:"image/x-icon",jng:"image/x-jng",sid:"image/x-mrsid-image",pcx:"image/x-pcx",pic:"image/x-pict",pct:"image/x-pict",pnm:"image/x-portable-anymap",pbm:"image/x-portable-bitmap",pgm:"image/x-portable-graymap",ppm:"image/x-portable-pixmap",rgb:"image/x-rgb",tga:"image/x-tga",xbm:"image/x-xbitmap",xpm:"image/x-xpixmap",xwd:"image/x-xwindowdump"}}).constant("CARD_TYPES",{Visa:{iconClass:"pf-visa",length:16,cvcLength:3},Maestro:{iconClass:"pf-credit-card",length:16,cvcLength:3},Forbrugsforeningen:{iconClass:"pf-credit-card",length:16,cvcLength:3},Dankort:{iconClass:"pf-credit-card",length:16,cvcLength:3},MasterCard:{iconClass:"pf-mastercard",length:16,cvcLength:3},"American Express":{iconClass:"pf-american-express",length:15,cvcLength:4},"Diners Club":{iconClass:"pf-diners",length:14,cvcLength:3},Discover:{iconClass:"pf-discover",length:16,cvcLength:3},JCB:{iconClass:"pf-jcb",length:16,cvcLength:3},UnionPay:{iconClass:"pf-credit-card",length:16,cvcLength:3}}),angular.module("app").filter("range",[rangeFilter]),angular.module("app").directive("finalize",[finalize]),angular.module("app").factory("FinalizeService",["$http",FinalizeService]),angular.module("app").directive("finalizeModal",[finalizeModal]);