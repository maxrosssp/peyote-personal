"use strict";function CropImageCtrl(e,t,r,n,i,o,a,l){var c,s,p,d,u,h,g=this,f=0;g.$onInit=function(){g.cropper={},g.cropperProxy="ctrl.cropper.callMethod",g.showEvent="show",g.hideEvent="hide",p=function(){e.$broadcast(g.showEvent)},d=function(){e.$broadcast(g.hideEvent)},g.options={viewMode:3,dragMode:"move",cropBoxMovable:!1,cropBoxResizable:!1,doubleClickToggle:!1,minContainerWidth:420,build:g.updatePreview,dragend:g.updatePreview,zoomin:g.updatePreview,zoomout:g.updatePreview,crop:function(e){s=e}};o.pixelsPerBead;g.heightOptions=o.heightOptions,g.widthOptions=o.widthOptions,g.selectedHeight=g.heightOptions[0].beads,g.selectedWidth=g.widthOptions[0].beads,g.previewHeight=650,g.getCroppedData=C,n(p)},g.$onChanges=function(e){e.blob&&e.blob.currentValue&&i.encode(c=e.blob.currentValue).then(function(e){g.cropper.callMethod("replace",e),n(function(){g.cropper.callMethod("setDragMode","move"),u=g.cropper.callMethod("getContainerData"),g.cropper.callMethod("setCanvasData",{top:0,height:u.height}),g.showEditButtons=!0,g.updatePreview()})})};var m=function(){if(g.cropper.callMethod&&u){var e=g.selectedWidth*o.beadWidth/(g.selectedHeight*o.beadHeight);g.previewWidth=parseInt(g.previewHeight*e),g.cropper.callMethod("setAspectRatio",e);var t=a.getResizeData(u,g.cropper.callMethod("getCanvasData"),g.cropper.callMethod("getImageData"),e);t.image&&g.cropper.callMethod("setCanvasData",t.image),g.cropper.callMethod("setCropBoxData",t.cropBox)}};g.rotate=function(e){g.cropper.callMethod&&(g.cropper.callMethod("rotate",f-g.rotation),f=g.rotation)},g.zoom=function(e){g.cropper.callMethod&&g.cropper.callMethod("zoom",e)},g.updatePreview=function(){return m(),v(g.previewHeight,g.previewWidth).then(function(e){h=e,g.previewUrl=e.toDataURL()})};var v=function(e,r){return c&&s?t.resolve(g.cropper.callMethod("getCroppedCanvas")).then(function(e){return l.getPalette(e,3)}).then(function(e){return a.bestColorOption(e,g.dominantColor)}).then(function(t){return g.cropper.callMethod("getCroppedCanvas",{height:e,width:r,fillColor:a.rgbToHex(t)})}):t.reject()},C=function(){return t.resolve(h)}}function cropImage(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{blob:"<",selectedHeight:"=beadHeight",selectedWidth:"=beadWidth",colorCount:"=",getCroppedData:"="},controller:["$scope","$q","$http","$timeout","Cropper","PEYOTE_VALUES","CropImageService","$colorThief",CropImageCtrl],controllerAs:"ctrl",templateUrl:"js/components/cropImage/cropImage.html"}}function CropImageService(e){var t=function(e,t){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2))},r=function(e){return function(r){return t(r,e)}},n=function(e){var t=e.toString(16);return 1==t.length?"0"+t:t};return{getResizeData:function(e,t,r,n){var i={width:e.height*n,height:e.height,top:0};i.left=(e.width-i.width)/2;var o;return t.width<i.width&&(o={width:i.width,height:i.width/r.aspectRatio}),i.left<t.left?o=angular.extend({},o,{left:i.left}):i.left+i.width>t.left+t.width&&(o=angular.extend({},o,{left:t.left+(i.left+i.width-(t.left+t.width))})),{image:o,cropBox:i}},bestColorOption:function(e,t){if(null===e||e.length<1||!t)return"#afa0af";e=angular.copy(e);var n=r(t);return e.sort(function(e,t){return n(e)-n(t)}),e[0]},rgbToHex:function(e){return"#"+n(e[0])+n(e[1])+n(e[2])}}}function fileUpload(){return{restrict:"E",require:"^^finalizeModal",scope:{label:"<"},link:function(e,t,r,n){e.onUpload=n.onFile},templateUrl:"js/components/fileUpload/fileUpload.html"}}function NavbarCtrl(){this.$onInit=function(){}}function navbar(){return{restrict:"E",scope:{},bindToController:{},controller:[NavbarCtrl],controllerAs:"ctrl",templateUrl:"js/components/navbar/navbar.html"}}function OrderReviewCtrl(e){var t=this;t.$onInit=function(){t.templatePrice=20,t.pricePerSquareInch=1.5,t.pricePerColor=1,t.priceForClasps=3,t.priceToShip=5,t.salesTax=.06,t.mustShip=r};var r=function(){return t.includeBeads||t.includeClasps};t.$onChanges=function(r){(r.beadHeight||r.beadWidth)&&(t.templateSize=e.calculateTemplateSize(t.beadHeight,t.beadWidth)),t.updateFinalPrice()},t.updateFinalPrice=function(){t.subtotal=e.calculateSubtotal({templateSize:t.templateSize,colorCount:t.colorCount,includeBeads:t.includeBeads,includeClasps:t.includeClasps});var n=e.shippingAndTaxCost(t.subtotal,r());t.finalPrice=t.subtotal+n}}function orderReview(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{beadHeight:"<",beadWidth:"<",colorCount:"<",finalPrice:"=",includeBeads:"=",includeClasps:"=",mustShip:"="},controller:["OrderReviewService",OrderReviewCtrl],controllerAs:"ctrl",templateUrl:"js/components/orderReview/orderReview.html"}}function OrderReviewService(e,t){return{calculateTemplateSize:function(t,r){var n=e.heightOptions.find(function(e){return e.beads===t})||{},i=e.widthOptions.find(function(e){return e.beads===r})||{},o=n.inches+" in. x "+i.inches+" in.",a=parseInt(n.beads)+" x "+i.beads+" beads";return{inches:{display:o,value:n.inches*i.inches},beads:{display:a,value:parseInt(n.beads)*i.beads}}},calculateSubtotal:function(e){var r=t.templatePrice;return e.includeBeads&&e.templateSize&&(r+=t.pricePerSquareInch*e.templateSize.inches.value,r+=t.pricePerColor*(e.colorCount-12)),e.includeClasps&&(r+=t.priceForClasps),r},shippingAndTaxCost:function(e,r){return e*t.salesTax+r?t.priceToShip:0}}}function MakePaymentCtrl(e){var t=this;t.$onInit=function(){t.finalizeCheckout=r};var r=function(r,n){return t.getToken().then(function(t){return e.finalize(r,n,t)})}}function makePayment(){return{restrict:"E",scope:{},bindToController:{mustShip:"&",totalPrice:"<",finalizeCheckout:"=",canCreateToken:"="},controller:["FinalizeService",MakePaymentCtrl],controllerAs:"ctrl",templateUrl:"js/components/payment/makePayment.html"}}function StripePaymentCtrl(e,t,r){var n=this,i={Visa:{iconClass:"pf-visa",possibleLengths:[16,19],cvcLength:3},Maestro:{iconClass:"pf-credit-card",possibleLengths:[16,19],cvcLength:3},Forbrugsforeningen:{iconClass:"pf-credit-card",possibleLengths:[16],cvcLength:3},Dankort:{iconClass:"pf-credit-card",possibleLengths:[16],cvcLength:3},MasterCard:{iconClass:"pf-mastercard",possibleLengths:[16],cvcLength:3},"American Express":{iconClass:"pf-american-express",possibleLengths:[15],cvcLength:4},"Diners Club":{iconClass:"pf-diners",possibleLengths:[14],cvcLength:3},Discover:{iconClass:"pf-discover",possibleLengths:[16],cvcLength:3},JCB:{iconClass:"pf-jcb",possibleLengths:[16],cvcLength:3},UnionPay:{iconClass:"pf-credit-card",possibleLengths:[16,19],cvcLength:3}};n.zipLength=5,n.$onInit=function(){n.getToken=a,n.card={},n.paymentForm={},n.canCreateToken=n.paymentForm.$valid,e.$watch(n.card.cvc,function(e,t){e&&e.length>i[n.paymentForm.cardNumber.$ccEagerType].cvcLength&&(n.card.cvc=t)})},n.getPfClass=function(e){return e?i[e].iconClass:"pf-credit-card"},n.inputClass=function(e){return n.paymentForm[e]&&o(e)?n.paymentForm[e].$invalid?"has-error":"has-success":""};var o=function(e){var t=n.paymentForm[e];if(t.$pristine)return!1;switch(e){case"cardNumber":return!!t.$ccEagerType&&-1!==i[t.$ccEagerType].possibleLengths.indexOf(t.$$rawModelValue.length);case"cardCvc":return t.$$rawModelValue.length>=3;case"cardAddressZip":return t.$$rawModelValue.length>=5;default:return!0}},a=function(){return r.card.createToken(n.card)}}function stripePayment(){return{restrict:"E",scope:{},bindToController:{getToken:"=",canCreateToken:"="},controller:["$scope","$q","stripe",StripePaymentCtrl],controllerAs:"ctrl",templateUrl:"js/components/payment/stripePayment/stripePayment.html"}}function PictureCarouselCtrl(){var e=this;e.$onInit=function(){e.images=[],e.interval=1e3*(e.picIntervalSeconds||5);for(var t=0;t<e.picCount;t++)e.images.push({url:e.picPath+"/"+e.picPrefix+(t+1)+"."+(e.picFileType||"png"),id:t})}}function pictureCarousel(){return{restrict:"E",scope:{},bindToController:{picPath:"@",picPrefix:"@",picCount:"@",picFileType:"@?",picIntervalSeconds:"@?"},controller:[PictureCarouselCtrl],controllerAs:"ctrl",templateUrl:"js/components/pictureCarousel/pictureCarousel.html"}}function pixelizer(e,t){return{restrict:"E",require:"^^finalizeModal",scope:{pixelizeId:"@",height:"@pixelizerHeight",width:"<pixelizerWidth"},link:function(r,n,i,o){r.progressbar=e.createInstance(),r.progressbar.setParent(angular.element(n).children()[0]),paper.setup(angular.element(n).children()[0].children[0]),r.$on("pixelize-"+r.pixelizeId,function(e,n,i,o){r.showPixelizedCanvas=!1,r.progressbar.start();var a=new paper.Raster(n,new paper.Point(0,0));a.on("load",function(){project.activeLayer.removeChildren(),a.fitBounds(paper.view.bounds,!0);var e=parseInt(i.columns),n=parseInt(i.rows),l=r.width/e,c=r.height/n;a.size=new paper.Size(e,n);for(var s=0;s<n;s++){for(var p=0;p<e;p++){var d=a.getPixel(new paper.Point(p,s)),u=new paper.Path.Rectangle(new paper.Point(p*l,s*c),new paper.Size(l,c)),h=t.bestColorOption(o,[256*d.red,256*d.green,256*d.blue]);u.fillColor=new paper.Color(h[0]/256,h[1]/256,h[2]/256)}r.progressbar.set(s/n*100)}r.progressbar.complete(),r.showPixelizedCanvas=!0}),paper.project.activeLayer.position=paper.view.center})},template:'<div id="{{pixelizeId}}-progress" ng-show="showPixelizedCanvas"><canvas id="{{pixelizeId}}" height="650" width="width"class="pixelizer"></canvas></div>'}}function Config(e,t,r,n){e.html5Mode({enabled:!0,requireBase:!1}).hashPrefix("!"),t.when("/",{templateUrl:"js/views/home.html"}).when("/about",{templateUrl:"js/views/about.html"}).when("/faq",{templateUrl:"js/views/faq.html"}).when("/contact",{templateUrl:"js/views/contact.html"}),t.otherwise({redirectTo:"/"}),r.errorOnUnhandledRejections(!1),n.setPublishableKey("pk_test_8lpNNwFVokUif3qxk2N7fPd6")}function rangeFilter(){return function(e,t,r,n){n=n||1,r=parseInt(r);for(var i=t;i<r;i+=n)e.push(i);return e}}function FinalizeCtrl(e,t){var r=this;r.$onInit=function(){e(function(){paper.install(window)})},r.checkout=function(){t.open({component:"finalizeModal",size:"lg",windowClass:"finalize-modal",backdrop:"static"}).closed.then(function(){console.log("Done")})}}function finalize(){return{restrict:"E",scope:{},bindToController:{buttonText:"@"},controller:["$timeout","$uibModal",FinalizeCtrl],controllerAs:"ctrl",templateUrl:"js/finalize/finalize.html"}}function FinalizeService(e){var t=function(t,r,n){return e({method:"POST",url:"/upload",data:{url:t,specs:r,token:n}})};return{finalize:function(e,r,n){return t(e,r,n).then(function(e){return console.log("Done with checkout"),console.log(e),e}).catch(function(e){return console.log("There was an error"),console.log(e),e})}}}function FinalizeModalCtrl(e,t,r,n,i){var o,a=this;a.$onInit=function(){a.modalPages={uploadImage:{id:"uploadImage",title:"Upload Image",next:"cropImage"},cropImage:{id:"cropImage",back:"uploadImage",title:"Crop Image",next:"reviewOrder"},reviewOrder:{id:"reviewOrder",back:"cropImage",title:"Review Order",next:"addPayment"},addPayment:{id:"addPayment",back:"reviewOrder",title:"Add Payment"}},a.currentPage=a.modalPages.uploadImage,a.colorCount=12,a.orderReviewPixelizerId="review-order-preview"},a.goToNextPage=function(){a.currentPage=a.modalPages[a.currentPage.next]},a.goToPreviousPage=function(){a.currentPage=a.modalPages[a.currentPage.back]},a.onFile=function(e){a.blob=e,t(function(){a.blob=e,a.goToNextPage()})},a.imageUploaded=function(){if("uploadImage"===a.currentPage.id)return angular.isDefined(a.blob)},a.cropAndContinue=function(){var t=a.selectedWidth*i.beadWidth/(a.selectedHeight*i.beadHeight);a.previewWidth=parseInt(650*t),a.getCroppedData().then(function(t){var r=t.toDataURL();o=angular.copy(r);var i={rows:a.selectedHeight,columns:a.selectedWidth},l=n.getPalette(t,a.colorCount);return e.$broadcast("pixelize-"+a.orderReviewPixelizerId,r,i,l),r}).then(function(e){a.goToNextPage()})},a.payAndContinue=function(){var e={beadHeight:a.selectedHeight,beadWidth:a.selectedWidth,colorCount:a.colorCount,includeBeads:a.includeBeads,includeClasps:a.includeClasps};return a.finalizeCheckout(o,e).then(function(e){return console.log(e),e})},a.close=function(){a.modalInstance.close()}}function finalizeModal(){return{restrict:"E",scope:{},bindToController:{modalInstance:"="},controller:["$scope","$timeout","$http","$colorThief","PEYOTE_VALUES",FinalizeModalCtrl],controllerAs:"ctrl",link:function(e,t,r,n){paper.install(e),e.$on("goToPage",function(e,t){n.currentPage=n.modalPages[t]})},templateUrl:"js/finalize/modal/finalizeModal.html"}}angular.module("app",["ngRoute","ngAnimate","ui.bootstrap","ui.bootstrap-slider","ngProgress","ngCropper","ngColorThief","angular-stripe","credit-cards"]),angular.module("app").directive("peyoteCrop",[cropImage]),angular.module("app").factory("CropImageService",["$q",CropImageService]),angular.module("app").directive("fileUpload",[fileUpload]),angular.module("app").directive("navbar",[navbar]),angular.module("app").directive("orderReview",[orderReview]),angular.module("app").factory("OrderReviewService",["PEYOTE_VALUES","PEYOTE_PRICES",OrderReviewService]),angular.module("app").directive("makePayment",[makePayment]),angular.module("app").directive("stripePayment",[stripePayment]),angular.module("app").directive("pictureCarousel",[pictureCarousel]),angular.module("app").directive("pixelizer",["ngProgressFactory","CropImageService",pixelizer]),angular.module("app").config(["$locationProvider","$routeProvider","$qProvider","stripeProvider",Config]),angular.module("app").constant("PEYOTE_VALUES",{braceletPixelWidth:600,pixelsPerInch:300,pixelsPerBead:28,heightOptions:[{beads:93.5,inches:6.5,description:"6.5 in."},{beads:100.5,inches:7,description:"7 in."},{beads:107.5,inches:7.5,description:"7.5 in."},{beads:114.5,inches:8,description:"8 in."},{beads:121.5,inches:8.5,description:"8.5 in."},{beads:129.5,inches:9,description:"9 in."},{beads:136.5,inches:9.5,description:"9.5 in."}],widthOptions:[{beads:24,inches:1.2,description:"Skinny (1.2 in.)"},{beads:27,inches:1.35,description:"Normal (1.35 in.)"},{beads:30,inches:1.5,description:"Wide (1.5 in.)"}],beadHeight:14,beadWidth:10}).constant("STRIPE",{publishableKey:"pk_test_8lpNNwFVokUif3qxk2N7fPd6"}).constant("PEYOTE_PRICES",{templatePrice:20,pricePerSquareInch:1.5,pricePerColor:1,priceForClasps:3,priceToShip:5,salesTax:.06}),angular.module("app").filter("range",[rangeFilter]),angular.module("app").directive("finalize",[finalize]),angular.module("app").factory("FinalizeService",["$http",FinalizeService]),angular.module("app").directive("finalizeModal",[finalizeModal]);