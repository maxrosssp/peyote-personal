"use strict";function CropImageCtrl(e,t,r,n,i,o,a){var l,c,p,d,s,u,h=this,f=0;h.$onInit=function(){h.cropper={},h.cropperProxy="ctrl.cropper.callMethod",h.showEvent="show",h.hideEvent="hide",p=function(){e.$broadcast(h.showEvent)},d=function(){e.$broadcast(h.hideEvent)},h.options={viewMode:3,dragMode:"move",cropBoxMovable:!1,cropBoxResizable:!1,doubleClickToggle:!1,minContainerWidth:420,build:h.updatePreview,dragend:h.updatePreview,zoomin:h.updatePreview,zoomout:h.updatePreview,crop:function(e){c=e}};i.pixelsPerBead;h.heightOptions=i.heightOptions,h.widthOptions=i.widthOptions,h.selectedHeight=h.heightOptions[0].beads,h.selectedWidth=h.widthOptions[0].beads,h.previewHeight=650,h.getCroppedData=v,r(p)},h.$onChanges=function(e){e.blob&&e.blob.currentValue&&n.encode(l=e.blob.currentValue).then(function(e){h.cropper.callMethod("replace",e),r(function(){h.cropper.callMethod("setDragMode","move"),s=h.cropper.callMethod("getContainerData"),h.cropper.callMethod("setCanvasData",{top:0,height:s.height}),h.showEditButtons=!0,h.updatePreview()})})};var g=function(){if(h.cropper.callMethod&&s){var e=h.selectedWidth*i.beadWidth/(h.selectedHeight*i.beadHeight);h.previewWidth=parseInt(h.previewHeight*e),h.cropper.callMethod("setAspectRatio",e);var t=o.getResizeData(s,h.cropper.callMethod("getCanvasData"),h.cropper.callMethod("getImageData"),e);t.image&&h.cropper.callMethod("setCanvasData",t.image),h.cropper.callMethod("setCropBoxData",t.cropBox)}};h.rotate=function(e){h.cropper.callMethod&&(h.cropper.callMethod("rotate",f-h.rotation),f=h.rotation)},h.zoom=function(e){h.cropper.callMethod&&h.cropper.callMethod("zoom",e)},h.updatePreview=function(){return g(),m(h.previewHeight,h.previewWidth).then(function(e){u=e,h.previewUrl=e.toDataURL()})};var m=function(e,r){return l&&c?t.resolve(h.cropper.callMethod("getCroppedCanvas")).then(function(e){return a.getPalette(e,3)}).then(function(e){return o.bestColorOption(e,h.dominantColor)}).then(function(t){return h.cropper.callMethod("getCroppedCanvas",{height:e,width:r,fillColor:o.rgbToHex(t)})}):t.reject()},v=function(){return t.resolve(u)}}function cropImage(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{blob:"<",selectedHeight:"=beadHeight",selectedWidth:"=beadWidth",colorCount:"=",getCroppedData:"="},controller:["$scope","$q","$timeout","Cropper","PEYOTE_VALUES","CropImageService","$colorThief",CropImageCtrl],controllerAs:"ctrl",templateUrl:"js/components/cropImage/cropImage.html"}}function CropImageService(e){var t=function(e,t){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2))},r=function(e){return function(r){return t(r,e)}},n=function(e){var t=e.toString(16);return 1==t.length?"0"+t:t};return{getResizeData:function(e,t,r,n){var i={width:e.height*n,height:e.height,top:0};i.left=(e.width-i.width)/2;var o;return t.width<i.width&&(o={width:i.width,height:i.width/r.aspectRatio}),i.left<t.left?o=angular.extend({},o,{left:i.left}):i.left+i.width>t.left+t.width&&(o=angular.extend({},o,{left:t.left+(i.left+i.width-(t.left+t.width))})),{image:o,cropBox:i}},bestColorOption:function(e,t){if(null===e||e.length<1||!t)return"#afa0af";e=angular.copy(e);var n=r(t);return e.sort(function(e,t){return n(e)-n(t)}),e[0]},rgbToHex:function(e){return"#"+n(e[0])+n(e[1])+n(e[2])}}}function fileUpload(){return{restrict:"E",require:"^^finalizeModal",scope:{label:"<"},link:function(e,t,r,n){e.onUpload=n.onFile},templateUrl:"js/components/fileUpload/fileUpload.html"}}function NavbarCtrl(){this.$onInit=function(){}}function navbar(){return{restrict:"E",scope:{},bindToController:{},controller:[NavbarCtrl],controllerAs:"ctrl",templateUrl:"js/components/navbar/navbar.html"}}function OrderReviewCtrl(e,t,r,n){var i=this;i.$onInit=function(){i.templatePrice=20,i.pricePerSquareInch=1.5,i.pricePerColor=1,i.priceForClasps=3,i.priceToShip=5,i.salesTax=.06,i.mustShip=l};var o=function(){var e=n.heightOptions.find(function(e){return e.beads===i.beadHeight})||{},t=n.widthOptions.find(function(e){return e.beads===i.beadWidth})||{},r=e.inches+" in. x "+t.inches+" in.",o=parseInt(e.beads)+" x "+t.beads+" beads";return{inches:{display:r,value:e.inches*t.inches},beads:{display:o,value:parseInt(e.beads)*t.beads}}},a=function(){var e=i.templatePrice;return i.includeBeads&&i.templateSize&&(e+=i.pricePerSquareInch*i.templateSize.inches.value,e+=i.pricePerColor*(i.colorCount-12)),i.includeClasps&&(e+=i.priceForClasps),e},l=function(){return i.includeBeads||i.includeClasps};i.$onChanges=function(e){(e.beadHeight||e.beadWidth)&&(i.templateSize=o()),i.updateFinalPrice()},i.updateFinalPrice=function(){i.subtotal=a();var e=i.subtotal*(1+i.salesTax);l()&&(e+=i.priceToShip),i.finalPrice=e}}function orderReview(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{beadHeight:"<",beadWidth:"<",colorCount:"<",finalPrice:"=",mustShip:"="},controller:["$scope","$timeout","$colorThief","PEYOTE_VALUES",OrderReviewCtrl],controllerAs:"ctrl",templateUrl:"js/components/orderReview/orderReview.html"}}function MakePaymentCtrl(e,t,r,n){var i,o,a,l,c,p=this,d={};p.$onInit=function(){p.zipCodeLength=5,l={visa:"pf-visa",mastercard:"pf-mastercard",amex:"pf-american-express",discover:"pf-discover",diners:"pf-diners",jcb:"pf-jcb",unknown:"pf-credit-card"},i=angular.element(t.document)[0];(o=t.Stripe(n.publishableKey)).charges;var e=o.elements();a=e.create("cardNumber",{classes:{base:"form-control"}});var r=e.create("cardExpiry",{classes:{base:"form-control"}}),h=e.create("cardCvc",{classes:{base:"form-control"}});a.mount("#card-number"),r.mount("#card-expiry"),h.mount("#card-cvc"),a.on("change",function(e){e.brand&&u(e.brand),d.cardNumber=e.complete,p.canContinue()}),r.on("change",function(e){d.cardExpiry=e.complete,p.canContinue()}),h.on("change",function(e){d.cardCvc=e.complete,p.canContinue()}),c=s()};var s=function(){return!!(d.cardNumber&&d.cardExpiry&&d.cardCvc)&&(!!p.cardholderName&&!(!p.zipCode||p.zipCode.length<5))};p.canContinue=function(){c&&!s()?(e.$emit("can-continue-with-payment",!1),c=!1):!c&&s()&&(e.$emit("can-continue-with-payment",!0),c=!0,h())};var u=function(e){var t=i.getElementById("brand-icon"),r="pf-credit-card";e in l&&(r=l[e]);for(var n=t.classList.length-1;n>=0;n--)t.classList.remove(t.classList[n]);t.classList.add("pf"),t.classList.add(r)},h=function(){var e={name:p.cardholderName,address_zip:p.zipCode};return o.createToken(a,e).then(function(e){return e.token||r.reject(e.error||e)})};p.checkout=function(){return h().then(function(e){}).catch(function(e){})}}function makePayment(){return{restrict:"E",scope:{},bindToController:{mustShip:"&",totalPrice:"<"},controller:["$scope","$window","$q","STRIPE",MakePaymentCtrl],controllerAs:"ctrl",templateUrl:"js/components/payment/makePayment.html"}}function PictureCarouselCtrl(){var e=this;e.$onInit=function(){e.images=[],e.interval=1e3*(e.picIntervalSeconds||5);for(var t=0;t<e.picCount;t++)e.images.push({url:e.picPath+"/"+e.picPrefix+(t+1)+"."+(e.picFileType||"png"),id:t})}}function pictureCarousel(){return{restrict:"E",scope:{},bindToController:{picPath:"@",picPrefix:"@",picCount:"@",picFileType:"@?",picIntervalSeconds:"@?"},controller:[PictureCarouselCtrl],controllerAs:"ctrl",templateUrl:"js/components/pictureCarousel/pictureCarousel.html"}}function pixelizer(e,t){return{restrict:"E",require:"^^finalizeModal",scope:{pixelizeId:"@",height:"@pixelizerHeight",width:"<pixelizerWidth"},link:function(r,n,i,o){r.progressbar=e.createInstance(),r.progressbar.setParent(angular.element(n).children()[0]),paper.setup(angular.element(n).children()[0].children[0]),r.$on("pixelize-"+r.pixelizeId,function(e,n,i,o){r.showPixelizedCanvas=!1,r.progressbar.start();var a=new paper.Raster(n,new paper.Point(0,0));a.on("load",function(){project.activeLayer.removeChildren(),a.fitBounds(paper.view.bounds,!0);var e=parseInt(i.columns),n=parseInt(i.rows),l=r.width/e,c=r.height/n;a.size=new paper.Size(e,n);for(var p=0;p<n;p++){for(var d=0;d<e;d++){var s=a.getPixel(new paper.Point(d,p)),u=new paper.Path.Rectangle(new paper.Point(d*l,p*c),new paper.Size(l,c)),h=t.bestColorOption(o,[256*s.red,256*s.green,256*s.blue]);u.fillColor=new paper.Color(h[0]/256,h[1]/256,h[2]/256)}r.progressbar.set(p/n*100)}r.progressbar.complete(),r.showPixelizedCanvas=!0}),paper.project.activeLayer.position=paper.view.center})},template:'<div id="{{pixelizeId}}-progress" ng-show="showPixelizedCanvas"><canvas id="{{pixelizeId}}" height="650" width="width"class="pixelizer"></canvas></div>'}}function Config(e,t,r){e.hashPrefix("!"),e.html5Mode({enabled:!1,requireBase:!1}),t.when("/home",{templateUrl:"js/views/home.html"}).when("/about",{templateUrl:"js/views/about.html"}).when("/faq",{templateUrl:"js/views/faq.html"}).when("/contact",{templateUrl:"js/views/contact.html"}),t.otherwise({redirectTo:"/home"})}function rangeFilter(){return function(e,t,r,n){n=n||1,r=parseInt(r);for(var i=t;i<r;i+=n)e.push(i);return e}}function FinalizeCtrl(e,t){var r=this;r.$onInit=function(){new AWS.S3({params:{Bucket:"peyote-personal-orders"}}).putObject({Key:"newPhoto",Body:"File",ContentType:"String"},function(e,t){console.log(e),console.log(t)});e(function(){paper.install(window)})},r.checkout=function(){t.open({component:"finalizeModal",size:"lg",windowClass:"finalize-modal",backdrop:"static"}).closed.then(function(){console.log("Done")})}}function finalize(){return{restrict:"E",scope:{},bindToController:{buttonText:"@"},controller:["$timeout","$uibModal",FinalizeCtrl],controllerAs:"ctrl",templateUrl:"js/finalize/finalize.html"}}function FinalizeModalCtrl(e,t,r,n){var i=this;i.$onInit=function(){i.modalPages={uploadImage:{id:"uploadImage",title:"Upload Image",next:"cropImage"},cropImage:{id:"cropImage",back:"uploadImage",title:"Crop Image",next:"reviewOrder"},reviewOrder:{id:"reviewOrder",back:"cropImage",title:"Review Order",next:"addPayment"},addPayment:{id:"addPayment",back:"reviewOrder",title:"Add Payment"}},i.currentPage=i.modalPages.uploadImage,i.colorCount=12,i.orderReviewPixelizerId="review-order-preview",e.$on("can-continue-with-payment",function(e,r){t(function(){i.canContinueWithPayment=r})})},i.goToNextPage=function(){i.currentPage=i.modalPages[i.currentPage.next]},i.goToPreviousPage=function(){i.currentPage=i.modalPages[i.currentPage.back]},i.onFile=function(e){i.blob=e,t(function(){i.blob=e,i.goToNextPage()})},i.imageUploaded=function(){if("uploadImage"===i.currentPage.id)return angular.isDefined(i.blob)},i.cropAndContinue=function(){var t=i.selectedWidth*n.beadWidth/(i.selectedHeight*n.beadHeight);i.previewWidth=parseInt(650*t),i.getCroppedData().then(function(t){var n=t.toDataURL(),o={rows:i.selectedHeight,columns:i.selectedWidth},a=r.getPalette(t,i.colorCount);return e.$broadcast("pixelize-"+i.orderReviewPixelizerId,n,o,a),n}).then(function(e){i.goToNextPage()})},i.close=function(){i.modalInstance.close()}}function finalizeModal(){return{restrict:"E",scope:{},bindToController:{modalInstance:"="},controller:["$scope","$timeout","$colorThief","PEYOTE_VALUES",FinalizeModalCtrl],controllerAs:"ctrl",link:function(e,t,r,n){paper.install(e),e.$on("goToPage",function(e,t){n.currentPage=n.modalPages[t]})},templateUrl:"js/finalize/modal/finalizeModal.html"}}angular.module("app",["ngRoute","ngAnimate","ui.bootstrap","ui.bootstrap-slider","ngProgress","ngCropper","ngColorThief","angular-stripe"]),angular.module("app").directive("peyoteCrop",[cropImage]),angular.module("app").factory("CropImageService",["$q",CropImageService]),angular.module("app").directive("fileUpload",[fileUpload]),angular.module("app").directive("navbar",[navbar]),angular.module("app").directive("orderReview",[orderReview]),angular.module("app").directive("makePayment",[makePayment]),angular.module("app").directive("pictureCarousel",[pictureCarousel]),angular.module("app").directive("pixelizer",["ngProgressFactory","CropImageService",pixelizer]),angular.module("app").config(["$locationProvider","$routeProvider","STRIPE",Config]),angular.module("app").constant("PEYOTE_VALUES",{braceletPixelWidth:600,pixelsPerInch:300,pixelsPerBead:28,heightOptions:[{beads:93.5,inches:6.5,description:"6.5 in."},{beads:100.5,inches:7,description:"7 in."},{beads:107.5,inches:7.5,description:"7.5 in."},{beads:114.5,inches:8,description:"8 in."},{beads:121.5,inches:8.5,description:"8.5 in."},{beads:129.5,inches:9,description:"9 in."},{beads:136.5,inches:9.5,description:"9.5 in."}],widthOptions:[{beads:24,inches:1.2,description:"Skinny (1.2 in.)"},{beads:27,inches:1.35,description:"Normal (1.35 in.)"},{beads:30,inches:1.5,description:"Wide (1.5 in.)"}],beadHeight:14,beadWidth:10}).constant("STRIPE",{publishableKey:"pk_test_8lpNNwFVokUif3qxk2N7fPd6"}),angular.module("app").filter("range",[rangeFilter]),angular.module("app").directive("finalize",[finalize]),angular.module("app").directive("finalizeModal",[finalizeModal]);