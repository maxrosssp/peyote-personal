"use strict";function CropImageCtrl(e,t,i,r,n,a,o,l){var c,p,d,s,u,g=this,m=0;g.$onInit=function(){g.cropper={},g.cropperProxy="ctrl.cropper.callMethod",g.showEvent="show",g.hideEvent="hide",p=function(){e.$broadcast(g.showEvent)},d=function(){e.$broadcast(g.hideEvent)},g.options={viewMode:3,dragMode:"move",cropBoxMovable:!1,cropBoxResizable:!1,doubleClickToggle:!1,minContainerWidth:420,build:g.updatePreview,dragend:g.updatePreview,zoomin:g.updatePreview,zoomout:g.updatePreview,crop:function(e){c=e}};a.pixelsPerBead;g.heightOptions=a.heightOptions,g.widthOptions=a.widthOptions,g.selectedHeight=g.heightOptions[0].beads,g.selectedWidth=g.widthOptions[0].beads,g.previewHeight=650,g.getCroppedData=b,r(p)},g.$onChanges=function(e){e.uploadedFile&&e.uploadedFile.currentValue?n.encode(e.uploadedFile.currentValue).then(function(e){g.cropper.callMethod("replace",e),r(h)}):e.downloadedUrl&&e.downloadedUrl.currentValue&&(g.cropper.callMethod("replace",e.downloadedUrl.currentValue),r(h))};var h=function(){g.cropper.callMethod("setDragMode","move"),s=g.cropper.callMethod("getContainerData"),g.cropper.callMethod("setCanvasData",{top:0,height:s.height}),g.showEditButtons=!0,g.updatePreview()},f=function(){if(g.cropper.callMethod&&s){var e=g.selectedWidth*a.beadWidth/(g.selectedHeight*a.beadHeight);g.previewWidth=parseInt(g.previewHeight*e),g.cropper.callMethod("setAspectRatio",e);var t=o.getResizeData(s,g.cropper.callMethod("getCanvasData"),g.cropper.callMethod("getImageData"),e);t.image&&g.cropper.callMethod("setCanvasData",t.image),g.cropper.callMethod("setCropBoxData",t.cropBox)}};g.rotate=function(e){g.cropper.callMethod&&(g.cropper.callMethod("rotate",m-g.rotation),m=g.rotation)},g.zoom=function(e){g.cropper.callMethod&&g.cropper.callMethod("zoom",e)},g.updatePreview=function(){return f(),v(g.previewHeight,g.previewWidth).then(function(e){u=e,g.previewUrl=e.toDataURL()})};var v=function(e,i){return c?t.resolve(g.cropper.callMethod("getCroppedCanvas")).then(function(e){return l.getPalette(e,3)}).then(function(e){return o.bestColorOption(e,g.dominantColor)}).then(function(t){return g.cropper.callMethod("getCroppedCanvas",{height:e,width:i,fillColor:o.rgbToHex(t)})}):t.reject()},b=function(){return t.resolve(u)}}function cropImage(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{uploadedFile:"<",downloadedUrl:"<",selectedHeight:"=beadHeight",selectedWidth:"=beadWidth",colorCount:"=",getCroppedData:"="},controller:["$scope","$q","$http","$timeout","Cropper","PEYOTE_VALUES","CropImageService","$colorThief",CropImageCtrl],controllerAs:"ctrl",templateUrl:"js/components/cropImage/cropImage.html"}}function CropImageService(e){var t=function(e,t){return Math.sqrt(Math.pow(t[0]-e[0],2)+Math.pow(t[1]-e[1],2)+Math.pow(t[2]-e[2],2))},i=function(e){return function(i){return t(i,e)}},r=function(e){var t=e.toString(16);return 1==t.length?"0"+t:t};return{getResizeData:function(e,t,i,r){var n={width:e.height*r,height:e.height,top:0};n.left=(e.width-n.width)/2;var a;return t.width<n.width&&(a={width:n.width,height:n.width/i.aspectRatio}),n.left<t.left?a=angular.extend({},a,{left:n.left}):n.left+n.width>t.left+t.width&&(a=angular.extend({},a,{left:t.left+(n.left+n.width-(t.left+t.width))})),{image:a,cropBox:n}},bestColorOption:function(e,t){if(null===e||e.length<1||!t)return"#afa0af";e=angular.copy(e);var r=i(t);return e.sort(function(e,t){return r(e)-r(t)}),e[0]},rgbToHex:function(e){return"#"+r(e[0])+r(e[1])+r(e[2])}}}function FileUploadCtrl(e,t,i){var r=this;r.checkLink=function(t){return n(t).then(function(t){e.onDownload(t)}).catch(function(e){r.linkError=!0,r.linkErrorMessage=e.data})},r.updateLink=function(){r.linkError=!1};var n=function(e){return t({method:"POST",url:"/image/download",data:{imageUrl:e}}).then(function(e){return e.data})}}function fileUpload(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{fileLabel:"<",linkLabel:"<"},controller:["$scope","$http","FileUploadService",FileUploadCtrl],controllerAs:"ctrl",link:function(e,t,i,r){e.onUpload=r.onFile,e.onDownload=r.onLink},templateUrl:"js/components/fileUpload/fileUpload.html"}}function FileUploadService(e){var t=function(e){return e&&e.length>1?255===e[0]&&216===e[1]&&255===e[2]?{ext:"jpg",mime:"image/jpeg"}:137===e[0]&&80===e[1]&&78===e[2]&&71===e[3]?{ext:"png",mime:"image/png"}:71===e[0]&&73===e[1]&&70===e[2]?{ext:"gif",mime:"image/gif"}:87===e[8]&&69===e[9]&&66===e[10]&&80===e[11]?{ext:"webp",mime:"image/webp"}:70===e[0]&&76===e[1]&&73===e[2]&&70===e[3]?{ext:"flif",mime:"image/flif"}:(73===e[0]&&73===e[1]&&42===e[2]&&0===e[3]||77===e[0]&&77===e[1]&&0===e[2]&&42===e[3])&&67===e[8]&&82===e[9]?{ext:"cr2",mime:"image/x-canon-cr2"}:73===e[0]&&73===e[1]&&42===e[2]&&0===e[3]||77===e[0]&&77===e[1]&&0===e[2]&&42===e[3]?{ext:"tif",mime:"image/tiff"}:66===e[0]&&77===e[1]?{ext:"bmp",mime:"image/bmp"}:73===e[0]&&73===e[1]&&188===e[2]?{ext:"jxr",mime:"image/vnd.ms-photo"}:56===e[0]&&66===e[1]&&80===e[2]&&83===e[3]?{ext:"psd",mime:"image/vnd.adobe.photoshop"}:0===e[0]&&0===e[1]&&1===e[2]&&0===e[3]?{ext:"ico",mime:"image/x-icon"}:null:null},i=function(t,i){var r=t.replace(/.*[\.\/\\]/,"").toLowerCase();return e.imageTypes[r]||i||e.imageTypes.jpg};return{getMIMEFromBuffer:function(e,r){var n=t(e);return n?n.mime:r?i(r):null},getFileTypeFromBuffer:t}}function NavbarCtrl(){this.$onInit=function(){}}function navbar(){return{restrict:"E",scope:{},bindToController:{},controller:[NavbarCtrl],controllerAs:"ctrl",templateUrl:"js/components/navbar/navbar.html"}}function OrderReviewCtrl(e){var t=this;t.$onInit=function(){t.templatePrice=20,t.pricePerSquareInch=1.5,t.pricePerColor=1,t.priceForClasps=3,t.priceToShip=5,t.salesTax=.06,t.mustShip=i};var i=function(){return t.includeBeads||t.includeClasps};t.$onChanges=function(i){(i.beadHeight||i.beadWidth)&&(t.templateSize=e.calculateTemplateSize(t.beadHeight,t.beadWidth)),t.updateFinalPrice()},t.updateFinalPrice=function(){t.subtotal=e.calculateSubtotal({templateSize:t.templateSize,colorCount:t.colorCount,includeBeads:t.includeBeads,includeClasps:t.includeClasps});var r=e.shippingAndTaxCost(t.subtotal,i());t.finalPrice=t.subtotal+r}}function orderReview(){return{restrict:"E",require:"^^finalizeModal",scope:{},bindToController:{beadHeight:"<",beadWidth:"<",colorCount:"<",finalPrice:"=",includeBeads:"=",includeClasps:"=",mustShip:"="},controller:["OrderReviewService",OrderReviewCtrl],controllerAs:"ctrl",templateUrl:"js/components/orderReview/orderReview.html"}}function OrderReviewService(e,t){return{calculateTemplateSize:function(t,i){var r=e.heightOptions.find(function(e){return e.beads===t})||{},n=e.widthOptions.find(function(e){return e.beads===i})||{},a=r.inches+" in. x "+n.inches+" in.",o=parseInt(r.beads)+" x "+n.beads+" beads";return{inches:{display:a,value:r.inches*n.inches},beads:{display:o,value:parseInt(r.beads)*n.beads}}},calculateSubtotal:function(e){var i=t.templatePrice;return e.includeBeads&&e.templateSize&&(i+=t.pricePerSquareInch*e.templateSize.inches.value,i+=t.pricePerColor*(e.colorCount-12)),e.includeClasps&&(i+=t.priceForClasps),i},shippingAndTaxCost:function(e,i){return e*t.salesTax+(i?t.priceToShip:0)}}}function MakePaymentCtrl(e){var t=this;t.$onInit=function(){t.finalizeCheckout=i};var i=function(i,r){return t.getToken().then(function(t){return e.finalize(i,r,t)})}}function makePayment(){return{restrict:"E",scope:{},bindToController:{mustShip:"&",totalPrice:"<",finalizeCheckout:"=",canCreateToken:"="},controller:["FinalizeService",MakePaymentCtrl],controllerAs:"ctrl",templateUrl:"js/components/payment/makePayment.html"}}function StripePaymentCtrl(e,t,i,r){var n=this;n.zipLength=5,n.$onInit=function(){n.getToken=o,n.card={},n.paymentForm={},n.canCreateToken=n.paymentForm.$valid,e.$watch(n.card.cvc,function(e,t){e&&e.length>r[n.paymentForm.cardNumber.$ccEagerType].cvcLength&&(n.card.cvc=t)})},n.getPfClass=function(e){return e?r[e].iconClass:"pf-credit-card"},n.inputClass=function(e){return n.paymentForm[e]&&a(e)?n.paymentForm[e].$invalid?"has-error":"has-success":""};var a=function(e){var t=n.paymentForm[e];if(t.$pristine)return!1;switch(e){case"cardNumber":return!!t.$ccEagerType&&-1!==r[t.$ccEagerType].possibleLengths.indexOf(t.$$rawModelValue.length);case"cardCvc":return t.$$rawModelValue.length>=3;case"cardAddressZip":return t.$$rawModelValue.length>=5;default:return!0}},o=function(){return i.card.createToken(n.card)}}function stripePayment(){return{restrict:"E",scope:{},bindToController:{getToken:"=",canCreateToken:"="},controller:["$scope","$q","stripe","CARD_TYPES",StripePaymentCtrl],controllerAs:"ctrl",templateUrl:"js/components/payment/stripePayment/stripePayment.html"}}function PictureCarouselCtrl(){var e=this;e.$onInit=function(){e.images=[],e.interval=1e3*(e.picIntervalSeconds||5);for(var t=0;t<e.picCount;t++)e.images.push({url:e.picPath+"/"+e.picPrefix+(t+1)+"."+(e.picFileType||"png"),id:t})}}function pictureCarousel(){return{restrict:"E",scope:{},bindToController:{picPath:"@",picPrefix:"@",picCount:"@",picFileType:"@?",picIntervalSeconds:"@?"},controller:[PictureCarouselCtrl],controllerAs:"ctrl",templateUrl:"js/components/pictureCarousel/pictureCarousel.html"}}function pixelizer(e,t){return{restrict:"E",require:"^^finalizeModal",scope:{pixelizeId:"@",height:"@pixelizerHeight",width:"<pixelizerWidth"},link:function(i,r,n,a){i.progressbar=e.createInstance(),i.progressbar.setParent(angular.element(r).children()[0]),paper.setup(angular.element(r).children()[0].children[0]),i.$on("pixelize-"+i.pixelizeId,function(e,r,n,a){i.showPixelizedCanvas=!1,i.progressbar.start();var o=new paper.Raster(r,new paper.Point(0,0));o.on("load",function(){project.activeLayer.removeChildren(),o.fitBounds(paper.view.bounds,!0);var e=parseInt(n.columns),r=parseInt(n.rows),l=i.width/e,c=i.height/r;o.size=new paper.Size(e,r);for(var p=0;p<r;p++){for(var d=0;d<e;d++){var s=o.getPixel(new paper.Point(d,p)),u=new paper.Path.Rectangle(new paper.Point(d*l,p*c),new paper.Size(l,c)),g=t.bestColorOption(a,[256*s.red,256*s.green,256*s.blue]);u.fillColor=new paper.Color(g[0]/256,g[1]/256,g[2]/256)}i.progressbar.set(p/r*100)}i.progressbar.complete(),i.showPixelizedCanvas=!0}),paper.project.activeLayer.position=paper.view.center})},template:'<div id="{{pixelizeId}}-progress" ng-show="showPixelizedCanvas"><canvas id="{{pixelizeId}}" height="650" width="width"class="pixelizer"></canvas></div>'}}function Config(e,t,i,r,n){e.html5Mode({enabled:!0,requireBase:!1}).hashPrefix("!"),t.when("/",{templateUrl:"js/views/home.html"}).when("/about",{templateUrl:"js/views/about.html"}).when("/faq",{templateUrl:"js/views/faq.html"}).when("/contact",{templateUrl:"js/views/contact.html"}),t.otherwise({redirectTo:"/"}),i.errorOnUnhandledRejections(!1),r.setPublishableKey("pk_test_8lpNNwFVokUif3qxk2N7fPd6"),n.defaults.useXDomain=!0}function rangeFilter(){return function(e,t,i,r){r=r||1,i=parseInt(i);for(var n=t;n<i;n+=r)e.push(n);return e}}function FinalizeCtrl(e,t){var i=this;i.$onInit=function(){e(function(){paper.install(window)})},i.checkout=function(){t.open({component:"finalizeModal",size:"lg",windowClass:"finalize-modal",backdrop:"static"}).closed.then(function(){console.log("Done")})}}function finalize(){return{restrict:"E",scope:{},bindToController:{buttonText:"@"},controller:["$timeout","$uibModal",FinalizeCtrl],controllerAs:"ctrl",templateUrl:"js/finalize/finalize.html"}}function FinalizeService(e){var t=function(t,i,r){return e({method:"POST",url:"/checkout",data:{url:t,specs:i,token:r}})};return{finalize:function(e,i,r){return t(e,i,r).then(function(e){return console.log("Done with checkout"),console.log(e),e}).catch(function(e){return console.log("There was an error"),console.log(e),e})}}}function FinalizeModalCtrl(e,t,i,r,n){var a,o=this;o.$onInit=function(){o.modalPages={uploadImage:{id:"uploadImage",title:"Upload Image",next:"cropImage"},cropImage:{id:"cropImage",back:"uploadImage",title:"Crop Image",next:"reviewOrder"},reviewOrder:{id:"reviewOrder",back:"cropImage",title:"Review Order",next:"addPayment"},addPayment:{id:"addPayment",back:"reviewOrder",title:"Add Payment"}},o.currentPage=o.modalPages.uploadImage,o.colorCount=12,o.orderReviewPixelizerId="review-order-preview"},o.goToNextPage=function(){o.currentPage=o.modalPages[o.currentPage.next]},o.goToPreviousPage=function(){o.currentPage=o.modalPages[o.currentPage.back]},o.onFile=function(e){t(function(){o.uploadedFile=e,o.goToNextPage()})},o.onLink=function(e){t(function(){o.downloadedUrl=e,o.goToNextPage()})},o.imageUploaded=function(){return angular.isDefined(o.uploadedFile)||angular.isDefined(o.downloadedUrl)},o.cropAndContinue=function(){var t=o.selectedWidth*n.beadWidth/(o.selectedHeight*n.beadHeight);o.previewWidth=parseInt(650*t),o.getCroppedData().then(function(t){var i=t.toDataURL();a=angular.copy(i);var n={rows:o.selectedHeight,columns:o.selectedWidth},l=r.getPalette(t,o.colorCount);return e.$broadcast("pixelize-"+o.orderReviewPixelizerId,i,n,l),i}).then(function(e){o.goToNextPage()})},o.payAndContinue=function(){var e={beadHeight:o.selectedHeight,beadWidth:o.selectedWidth,colorCount:o.colorCount,includeBeads:o.includeBeads,includeClasps:o.includeClasps};return o.finalizeCheckout(a,e).then(function(e){return console.log(e),e})},o.close=function(){o.modalInstance.close()}}function finalizeModal(){return{restrict:"E",scope:{},bindToController:{modalInstance:"="},controller:["$scope","$timeout","$http","$colorThief","PEYOTE_VALUES",FinalizeModalCtrl],controllerAs:"ctrl",link:function(e,t,i,r){paper.install(e),e.$on("goToPage",function(e,t){r.currentPage=r.modalPages[t]})},templateUrl:"js/finalize/modal/finalizeModal.html"}}angular.module("app",["ngRoute","ngAnimate","ui.bootstrap","ui.bootstrap-slider","ngProgress","ngCropper","ngColorThief","angular-stripe","credit-cards"]),angular.module("app").directive("peyoteCrop",[cropImage]),angular.module("app").factory("CropImageService",["$q",CropImageService]),angular.module("app").directive("fileUpload",[fileUpload]),angular.module("app").factory("FileUploadService",["$http",FileUploadService]),angular.module("app").directive("navbar",[navbar]),angular.module("app").directive("orderReview",[orderReview]),angular.module("app").factory("OrderReviewService",["PEYOTE_VALUES","PEYOTE_PRICES",OrderReviewService]),angular.module("app").directive("makePayment",[makePayment]),angular.module("app").directive("stripePayment",[stripePayment]),angular.module("app").directive("pictureCarousel",[pictureCarousel]),angular.module("app").directive("pixelizer",["ngProgressFactory","CropImageService",pixelizer]),angular.module("app").config(["$locationProvider","$routeProvider","$qProvider","stripeProvider","$httpProvider",Config]),angular.module("app").constant("PEYOTE_VALUES",{braceletPixelWidth:600,pixelsPerInch:300,pixelsPerBead:28,heightOptions:[{beads:93.5,inches:6.5,description:"6.5 in."},{beads:100.5,inches:7,description:"7 in."},{beads:107.5,inches:7.5,description:"7.5 in."},{beads:114.5,inches:8,description:"8 in."},{beads:121.5,inches:8.5,description:"8.5 in."},{beads:129.5,inches:9,description:"9 in."},{beads:136.5,inches:9.5,description:"9.5 in."}],widthOptions:[{beads:24,inches:1.2,description:"Skinny (1.2 in.)"},{beads:27,inches:1.35,description:"Normal (1.35 in.)"},{beads:30,inches:1.5,description:"Wide (1.5 in.)"}],beadHeight:14,beadWidth:10}).constant("STRIPE",{publishableKey:"pk_test_8lpNNwFVokUif3qxk2N7fPd6"}).constant("PEYOTE_PRICES",{templatePrice:20,pricePerSquareInch:1.5,pricePerColor:1,priceForClasps:3,priceToShip:5,salesTax:.06}).constant("MIME",{imageTypes:{apng:"image/apng",bmp:"image/x-ms-bmp",cgm:"image/cgm",g3:"image/g3fax",gif:"image/gif",ief:"image/ief",jpeg:"image/jpeg",jpg:"image/jpeg",jpe:"image/jpeg",ktx:"image/ktx",png:"image/png",btif:"image/prs.btif",sgi:"image/sgi",svg:"image/svg+xml",svgz:"image/svg+xml",tiff:"image/tiff",tif:"image/tiff",psd:"image/vnd.adobe.photoshop",uvi:"image/vnd.dece.graphic",uvvi:"image/vnd.dece.graphic",uvg:"image/vnd.dece.graphic",uvvg:"image/vnd.dece.graphic",djvu:"image/vnd.djvu",djv:"image/vnd.djvu",sub:"text/vnd.dvb.subtitle",dwg:"image/vnd.dwg",dxf:"image/vnd.dxf",fbs:"image/vnd.fastbidsheet",fpx:"image/vnd.fpx",fst:"image/vnd.fst",mmr:"image/vnd.fujixerox.edmics-mmr",rlc:"image/vnd.fujixerox.edmics-rlc",mdi:"image/vnd.ms-modi",wdp:"image/vnd.ms-photo",npx:"image/vnd.net-fpx",wbmp:"image/vnd.wap.wbmp",xif:"image/vnd.xiff",webp:"image/webp","3ds":"image/x-3ds",ras:"image/x-cmu-raster",cmx:"image/x-cmx",fh:"image/x-freehand",fhc:"image/x-freehand",fh4:"image/x-freehand",fh5:"image/x-freehand",fh7:"image/x-freehand",ico:"image/x-icon",jng:"image/x-jng",sid:"image/x-mrsid-image",pcx:"image/x-pcx",pic:"image/x-pict",pct:"image/x-pict",pnm:"image/x-portable-anymap",pbm:"image/x-portable-bitmap",pgm:"image/x-portable-graymap",ppm:"image/x-portable-pixmap",rgb:"image/x-rgb",tga:"image/x-tga",xbm:"image/x-xbitmap",xpm:"image/x-xpixmap",xwd:"image/x-xwindowdump"}}).constant("CARD_TYPES",{Visa:{iconClass:"pf-visa",possibleLengths:[16,19],cvcLength:3},Maestro:{iconClass:"pf-credit-card",possibleLengths:[16,19],cvcLength:3},Forbrugsforeningen:{iconClass:"pf-credit-card",possibleLengths:[16],cvcLength:3},Dankort:{iconClass:"pf-credit-card",possibleLengths:[16],cvcLength:3},MasterCard:{iconClass:"pf-mastercard",possibleLengths:[16],cvcLength:3},"American Express":{iconClass:"pf-american-express",possibleLengths:[15],cvcLength:4},"Diners Club":{iconClass:"pf-diners",possibleLengths:[14],cvcLength:3},Discover:{iconClass:"pf-discover",possibleLengths:[16],cvcLength:3},JCB:{iconClass:"pf-jcb",possibleLengths:[16],cvcLength:3},UnionPay:{iconClass:"pf-credit-card",possibleLengths:[16,19],cvcLength:3}}),angular.module("app").filter("range",[rangeFilter]),angular.module("app").directive("finalize",[finalize]),angular.module("app").factory("FinalizeService",["$http",FinalizeService]),angular.module("app").directive("finalizeModal",[finalizeModal]);